{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Parse HIPAA Server on AWS Elastic Beanstalk - A Parse API server designed to support ParseCareKit based apps. NOTE: This template creates a basic deployment. For HIPAA compliance, you MUST configure HTTPS/SSL, enable Multi-AZ RDS, and review AWS HIPAA requirements.",
  "Parameters": {
    "ApplicationName": {
      "Type": "String",
      "Default": "parse-hipaa",
      "Description": "Name of the Elastic Beanstalk application",
      "MinLength": "1",
      "MaxLength": "100",
      "AllowedPattern": "[a-zA-Z0-9-]+",
      "ConstraintDescription": "Must contain only alphanumeric characters and hyphens"
    },
    "EnvironmentName": {
      "Type": "String",
      "Default": "parse-hipaa-env",
      "Description": "Name of the Elastic Beanstalk environment",
      "MinLength": "1",
      "MaxLength": "40",
      "AllowedPattern": "[a-zA-Z0-9-]+",
      "ConstraintDescription": "Must contain only alphanumeric characters and hyphens"
    },
    "DatabasePassword": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Password for the RDS PostgreSQL database (minimum 8 characters)",
      "MinLength": "8",
      "MaxLength": "41",
      "AllowedPattern": "[a-zA-Z0-9!@#$%^&*()_+=-]*",
      "ConstraintDescription": "Must be at least 8 characters with alphanumeric and special characters"
    },
    "DashboardUsername": {
      "Type": "String",
      "Default": "admin",
      "Description": "Username for Parse Dashboard login",
      "MinLength": "1",
      "MaxLength": "100"
    },
    "DashboardPassword": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Password for Parse Dashboard login (minimum 8 characters, will be bcrypt hashed)",
      "MinLength": "8",
      "MaxLength": "100"
    },
    "ParseServerApplicationId": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Unique identifier for your Parse app (minimum 32 characters, use 'openssl rand -hex 32' to generate)",
      "MinLength": "32",
      "MaxLength": "128"
    },
    "ParseServerPrimaryKey": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Master key for Parse Server (minimum 32 characters, use 'openssl rand -hex 32' to generate)",
      "MinLength": "32",
      "MaxLength": "128"
    },
    "ParseServerReadOnlyPrimaryKey": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Read-only master key (minimum 32 characters, use 'openssl rand -hex 32' to generate)",
      "MinLength": "32",
      "MaxLength": "128"
    },
    "ParseServerMaintenanceKey": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Maintenance key for Parse Server (minimum 32 characters, use 'openssl rand -hex 32' to generate)",
      "MinLength": "32",
      "MaxLength": "128"
    },
    "ParseServerWebhookKey": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Webhook key for Parse Server (minimum 32 characters, use 'openssl rand -hex 32' to generate)",
      "MinLength": "32",
      "MaxLength": "128"
    },
    "ParseServerEncryptionKey": {
      "Type": "String",
      "NoEcho": true,
      "Description": "File encryption key (minimum 32 characters, use 'openssl rand -hex 32' to generate)",
      "MinLength": "32",
      "MaxLength": "128"
    },
    "ParseDashboardCookieSessionSecret": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Cookie session secret for dashboard (minimum 32 characters, use 'openssl rand -hex 32' to generate)",
      "MinLength": "32",
      "MaxLength": "128"
    },
    "InstanceType": {
      "Type": "String",
      "Default": "t3.small",
      "Description": "EC2 instance type for the application",
      "AllowedValues": [
        "t3.micro",
        "t3.small",
        "t3.medium",
        "t3.large"
      ]
    },
    "DBInstanceClass": {
      "Type": "String",
      "Default": "db.t3.micro",
      "Description": "RDS instance type for PostgreSQL database",
      "AllowedValues": [
        "db.t3.micro",
        "db.t3.small",
        "db.t3.medium",
        "db.t3.large"
      ]
    },
    "EnableMultiAZ": {
      "Type": "String",
      "Default": "false",
      "Description": "Enable Multi-AZ deployment for RDS (recommended for production/HIPAA compliance)",
      "AllowedValues": ["true", "false"]
    }
  },
  "Resources": {
    "ParseHIPAAApplication": {
      "Type": "AWS::ElasticBeanstalk::Application",
      "Properties": {
        "ApplicationName": {
          "Ref": "ApplicationName"
        },
        "Description": "Parse HIPAA Server - HIPAA compliant Parse Server with PostgreSQL"
      }
    },
    "ParseHIPAAConfigurationTemplate": {
      "Type": "AWS::ElasticBeanstalk::ConfigurationTemplate",
      "Properties": {
        "ApplicationName": {
          "Ref": "ParseHIPAAApplication"
        },
        "Description": "Parse HIPAA Configuration Template",
        "SolutionStackName": "64bit Amazon Linux 2023 running Docker",
        "OptionSettings": [
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "InstanceType",
            "Value": {
              "Ref": "InstanceType"
            }
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "IamInstanceProfile",
            "Value": "aws-elasticbeanstalk-ec2-role"
          },
          {
            "Namespace": "aws:elasticbeanstalk:environment",
            "OptionName": "EnvironmentType",
            "Value": "SingleInstance"
          },
          {
            "Namespace": "aws:rds:dbinstance",
            "OptionName": "DBEngine",
            "Value": "postgres"
          },
          {
            "Namespace": "aws:rds:dbinstance",
            "OptionName": "DBEngineVersion",
            "Value": "16"
          },
          {
            "Namespace": "aws:rds:dbinstance",
            "OptionName": "DBInstanceClass",
            "Value": {
              "Ref": "DBInstanceClass"
            }
          },
          {
            "Namespace": "aws:rds:dbinstance",
            "OptionName": "DBAllocatedStorage",
            "Value": "20"
          },
          {
            "Namespace": "aws:rds:dbinstance",
            "OptionName": "DBUser",
            "Value": "parseuser"
          },
          {
            "Namespace": "aws:rds:dbinstance",
            "OptionName": "DBPassword",
            "Value": {
              "Ref": "DatabasePassword"
            }
          },
          {
            "Namespace": "aws:rds:dbinstance",
            "OptionName": "MultiAZDatabase",
            "Value": {
              "Ref": "EnableMultiAZ"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_DASHBOARD_USERNAMES",
            "Value": {
              "Ref": "DashboardUsername"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_DASHBOARD_USER_PASSWORDS",
            "Value": {
              "Ref": "DashboardPassword"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_DASHBOARD_USER_PASSWORD_ENCRYPTED",
            "Value": "false"
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_DASHBOARD_ALLOW_INSECURE_HTTP",
            "Value": "1"
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_DASHBOARD_START",
            "Value": "true"
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_SERVER_APPLICATION_ID",
            "Value": {
              "Ref": "ParseServerApplicationId"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_SERVER_PRIMARY_KEY",
            "Value": {
              "Ref": "ParseServerPrimaryKey"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_SERVER_READ_ONLY_PRIMARY_KEY",
            "Value": {
              "Ref": "ParseServerReadOnlyPrimaryKey"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_SERVER_MAINTENANCE_KEY",
            "Value": {
              "Ref": "ParseServerMaintenanceKey"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_SERVER_WEBHOOK_KEY",
            "Value": {
              "Ref": "ParseServerWebhookKey"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_SERVER_ENCRYPTION_KEY",
            "Value": {
              "Ref": "ParseServerEncryptionKey"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_DASHBOARD_COOKIE_SESSION_SECRET",
            "Value": {
              "Ref": "ParseDashboardCookieSessionSecret"
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_SERVER_MAINTENANCE_KEY_IPS",
            "Value": "127.0.0.1, ::1"
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "PARSE_SERVER_PRIMARY_KEY_IPS",
            "Value": "127.0.0.1, ::1"
          },
          {
            "Namespace": "aws:elasticbeanstalk:cloudwatch:logs",
            "OptionName": "StreamLogs",
            "Value": "true"
          },
          {
            "Namespace": "aws:elasticbeanstalk:cloudwatch:logs",
            "OptionName": "DeleteOnTerminate",
            "Value": "false"
          },
          {
            "Namespace": "aws:elasticbeanstalk:cloudwatch:logs",
            "OptionName": "RetentionInDays",
            "Value": "7"
          }
        ]
      }
    },
    "ParseHIPAAEnvironment": {
      "Type": "AWS::ElasticBeanstalk::Environment",
      "Properties": {
        "ApplicationName": {
          "Ref": "ParseHIPAAApplication"
        },
        "EnvironmentName": {
          "Ref": "EnvironmentName"
        },
        "Description": "Parse HIPAA Server Environment",
        "TemplateName": {
          "Ref": "ParseHIPAAConfigurationTemplate"
        }
      }
    }
  },
  "Outputs": {
    "ApplicationURL": {
      "Description": "URL of the Parse HIPAA Server (HTTP only - configure HTTPS for production)",
      "Value": {
        "Fn::GetAtt": [
          "ParseHIPAAEnvironment",
          "EndpointURL"
        ]
      }
    },
    "ParseServerURL": {
      "Description": "Parse Server API endpoint (HTTP only - configure HTTPS for production)",
      "Value": {
        "Fn::Sub": "http://${ParseHIPAAEnvironment.EndpointURL}/parse"
      }
    },
    "DashboardURL": {
      "Description": "Parse Dashboard URL (HTTP only - configure HTTPS for production)",
      "Value": {
        "Fn::Sub": "http://${ParseHIPAAEnvironment.EndpointURL}/dashboard"
      }
    },
    "DatabaseEndpoint": {
      "Description": "RDS Database Endpoint (for manual PARSE_SERVER_DATABASE_URI configuration if needed)",
      "Value": "Available via RDS_HOSTNAME environment variable in the application"
    },
    "SecurityNote": {
      "Description": "IMPORTANT: For HIPAA compliance",
      "Value": "This deployment uses HTTP. You MUST configure HTTPS/SSL, enable Multi-AZ RDS, use IAM roles for S3 access, and review AWS HIPAA compliance requirements before production use."
    }
  }
}
